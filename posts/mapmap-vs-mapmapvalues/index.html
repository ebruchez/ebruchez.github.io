<!DOCTYPE html><html lang="en" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Map.map vs. Map.mapValues" /><meta name="author" content="Erik Bruchez" /><meta property="og:locale" content="en_US" /><meta name="description" content="I just hit a bug caused by a misunderstanding of how Map.mapValues works. Consider:" /><meta property="og:description" content="I just hit a bug caused by a misunderstanding of how Map.mapValues works. Consider:" /><link rel="canonical" href="https://blog.bruchez.name/posts/mapmap-vs-mapmapvalues/" /><meta property="og:url" content="https://blog.bruchez.name/posts/mapmap-vs-mapmapvalues/" /><meta property="og:site_name" content="Erik’s Ponderings" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2013-02-03T17:29:00-08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Map.map vs. Map.mapValues" /><meta name="twitter:site" content="@ebruchez" /><meta name="twitter:creator" content="@Erik Bruchez" /><meta name="google-site-verification" content="irueyGKya5E07oltkTU3FJThmPxkQy-n1W1GOClvPIQ" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Erik Bruchez"},"dateModified":"2021-03-26T09:55:22-07:00","datePublished":"2013-02-03T17:29:00-08:00","description":"I just hit a bug caused by a misunderstanding of how Map.mapValues works. Consider:","headline":"Map.map vs. Map.mapValues","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.bruchez.name/posts/mapmap-vs-mapmapvalues/"},"url":"https://blog.bruchez.name/posts/mapmap-vs-mapmapvalues/"}</script><title>Map.map vs. Map.mapValues | Erik's Ponderings</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/public/headshot.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Erik's Ponderings</a></div><div class="site-subtitle font-italic">A blog and More</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/pages/" class="nav-link"> <i class="fa-fw fas fa-file ml-xl-3 mr-xl-3 unloaded"></i> <span>PAGES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ebruchez" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/ebruchez" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['erik','bruchez.org'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://feeds.feedburner.com/EriksPondering" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Map.map vs. Map.mapValues</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Map.map vs. Map.mapValues</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Feb 3, 2013, 5:29 PM -0800" > Feb 3, 2013 <i class="unloaded">2013-02-03T17:29:00-08:00</i> </span> by <span class="author"> Erik Bruchez </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Mar 26, 2021, 9:55 AM -0700" > Mar 26, 2021 <i class="unloaded">2021-03-26T09:55:22-07:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="458 words">2 min</span></div><div class="post-meta mb-3"> <a href='/categories/programming/'>Programming</a></div></div><div class="post-content"><p>I just hit a bug caused by a misunderstanding of how <code class="language-plaintext highlighter-rouge">Map.mapValues</code> works. Consider:</p><div class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">val</span> <span class="nv">original</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">"a"</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="o">,</span> <span class="s">"b"</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">modified</span> <span class="k">=</span> <span class="n">original</span> <span class="n">map</span> <span class="o">{</span> <span class="nf">case</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</pre></table></code></div></div><p>The result is an immutable map<sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup> which is a transformation of the original map (all values are incremented by one). Once the <code class="language-plaintext highlighter-rouge">map</code> method terminates, the new map is actually holding those new values.</p><p>Now <code class="language-plaintext highlighter-rouge">Map</code> also has a <code class="language-plaintext highlighter-rouge">mapValues</code> method, which seems like an attractive shortcut for the rather verbose transformation above. So you write:</p><div class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">val</span> <span class="nv">original</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">"a"</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="o">,</span> <span class="s">"b"</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">modified</span> <span class="k">=</span> <span class="n">original</span> <span class="nf">mapValues</span> <span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
</pre></table></code></div></div><p>More concise, right? But there is a catch: <code class="language-plaintext highlighter-rouge">map</code> and <code class="language-plaintext highlighter-rouge">mapValues</code> are different in a not-so-subtle way. <code class="language-plaintext highlighter-rouge">mapValues</code>, unlike <code class="language-plaintext highlighter-rouge">map</code>, returns a <em>view</em> on the original map. This view holds references to both the original map and to the transformation function (here <code class="language-plaintext highlighter-rouge">(_ + 1)</code>). Every time the returned map (view) is queried, the original map is first queried and the tranformation function is called on the result. You can see this in the source code of the Scala standard library:</p><div class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">override</span> <span class="k">def</span> <span class="nf">mapValues</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">B</span> <span class="o">=&gt;</span> <span class="n">C</span><span class="o">)</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">C</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DefaultMap</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">C</span><span class="o">]</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="k">def</span> <span class="nf">get</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="k">=</span> <span class="nv">self</span><span class="o">.</span><span class="py">get</span><span class="o">(</span><span class="n">key</span><span class="o">).</span><span class="py">map</span><span class="o">(</span><span class="n">f</span><span class="o">)</span>
<span class="o">}</span>
</pre></table></code></div></div><p>If the transformation function is referentially transparent, like <code class="language-plaintext highlighter-rouge">(_ + 1)</code>, all is well (besides performance considerations). But if not, you might be in for fun bugs depending on when the resulting map is queried. In my case, the transformation function depended on a context which, at a later point, was made invalid. When the resulting map was queried, the function-that-really-shouldn’t-run-now was running in that invalidated context and causing trouble.</p><p>There is nothing inherently wrong with providing a view on the original map, but I would say the naming of <code class="language-plaintext highlighter-rouge">mapValues</code> violates the principle of least surprise: everybody knows the <code class="language-plaintext highlighter-rouge">map</code> method, and might reasonably assume that <code class="language-plaintext highlighter-rouge">mapValues</code> would behave in a similar way (and it doesn’t).</p><p>Morality: when using <code class="language-plaintext highlighter-rouge">mapValues</code>, make sure the implications of using a view are acceptable, including making sure that your transformation function can safely run at the time the resulting map is queried. If not, prefer the good old <code class="language-plaintext highlighter-rouge">map</code> method. Oh, and also try to keep mutations local (but it’s often not easy).</p><div class="footnotes" role="doc-endnotes"><ol><li id="fn:1"><p>Scala has <code class="language-plaintext highlighter-rouge">Map</code> and <code class="language-plaintext highlighter-rouge">map</code>: <code class="language-plaintext highlighter-rouge">Map</code> denotes one of the traits for “a map from keys of type A to values of type B” (AKA a hash map), <code class="language-plaintext highlighter-rouge">map</code> is a method on collections, including <code class="language-plaintext highlighter-rouge">Map</code>, which “builds a new collection by applying a function to all elements of this map”. When I (and Scaladoc) use “map” as a noun, it means “it’s an instance of <code class="language-plaintext highlighter-rouge">Map</code>”. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/programming/'>Programming</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Updates</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/vail-resorts-epic-coverage-declined/">Beware of Vail Resorts' Epic Coverage</a><li><a href="/posts/restoring-ibm-memory-typewriter-1/">Restoring an IBM Memory Typewriter - Part 1</a><li><a href="/posts/apple-1-reproduction-part-7-audio-cassette-adapter/">Building an Apple-1 Reproduction in 2024/2025 - Part 7: The Audio Cassette Adapter</a><li><a href="/posts/apple-1-reproduction-part-6-c-programming/">Building an Apple-1 Reproduction in 2024/2025 - Part 6: C Programming</a><li><a href="/posts/apple-1-reproduction-part-3-retro-chip-tester/">Building an Apple-1 Reproduction in 2024 - Part 3: The Retro Chip Tester</a></ul></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/continuations-in-scala/"><div class="card-body"> <span class="timeago small" > Sep 17, 2011 <i class="unloaded">2011-09-17T16:15:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Continuations in Scala (without a PhD)</h3><div class="text-muted small"><p> With @avernet we have been thinking lately about continuations, for a few reasons: Continuations pop up on the web as a concept that could help with event-based programming Scala has a contin...</p></div></div></a></div><div class="card"> <a href="/posts/scala-partial-functions-without-phd/"><div class="card-body"> <span class="timeago small" > Oct 15, 2011 <i class="unloaded">2011-10-15T12:54:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Scala partial functions (without a PhD)</h3><div class="text-muted small"><p> If you have done some Scala for a while, you know about pattern matching and match/case. Things like: value match { case Some(value) =&gt; … case None =&gt; … } But there is another use of t...</p></div></div></a></div><div class="card"> <a href="/posts/scala-tip-import-renames/"><div class="card-body"> <span class="timeago small" > Jun 18, 2012 <i class="unloaded">2012-06-18T16:44:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Scala tip: import renames</h3><div class="text-muted small"><p> In Java, you often write things like this, which are rather verbose: URLEncoder.encode(...) URLDecoder.decode(...) Since Java 1.5 you can use static imports, but then you are stuck with the orig...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/implicit-conversion-to-unit-type-in/" class="btn btn-outline-primary" prompt="Older"><p>Implicit conversion to the Unit type in Scala</p></a> <a href="/posts/scala-array-comparison-without-phd/" class="btn btn-outline-primary" prompt="Newer"><p>Scala array comparison (without a PhD)</p></a></div><div id="disqus_thread"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script> var disqus_config = function() { this.page.url = 'https://blog.bruchez.name/posts/mapmap-vs-mapmapvalues/'; this.page.identifier = '/posts/mapmap-vs-mapmapvalues/'; }; (function() { var d = document; var s = d.createElement('script'); s.src = 'https://ebruchez.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="">Erik Bruchez</a>.</p></div><div class="footer-right"><p class="mb-0"></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://blog.bruchez.name{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
